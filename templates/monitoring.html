<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CCTV ê´€ì œì‹¤</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
    <style>
      /* 2ì—´ ë°°ì¹˜ë¥¼ ìœ„í•œ Playback ì „ìš© ìŠ¤íƒ€ì¼ */
      .playback-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        padding: 10px;
      }
      .evidence-card {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      .evidence-card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        display: block;
      }
      .evidence-info {
        padding: 10px;
        font-size: 0.9rem;
        line-height: 1.5;
      }
      .evidence-info b { color: #e74c3c; }
      .hidden { display: none; }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="left">
        <img id="logo" src="{{ url_for('static', filename='ê·¸ë¦¼1.png') }}" alt="logo" />
        <div class="brand">
          <h1>Yellow YOLO</h1>
          <div class="subtitle">CCTV ê´€ì œ ëŒ€ì‹œë³´ë“œ</div>
        </div>
      </div>
      <div class="right">
        <div id="userArea">
          <button id="loginBtn" class="btn">ë¡œê·¸ì¸</button>
        </div>
      </div>
    </header>

    <main class="container">
      <aside class="sidebar">
        <nav>
          <ul>
            <li><a href="#" data-page="overview">Overview</a></li>
            <li><a href="#" data-page="live" class="active">Live Feeds</a></li>
            <li><a href="#" data-page="playback">Playback</a></li>
            <li><a href="#" data-page="settings">Settings</a></li>
          </ul>
        </nav>
        <section class="status">
          <h4>âœ’ï¸ ìƒíƒœ ë° ê¸°ë¡</h4>
          <div class="status-subtitle">ì‹ í˜¸ë“± ì „ê´‘íŒ</div>
          <div class="signal-board" id="signalBoard" data-state="RED">RED</div>
          <div class="violation-wrap">
            <div class="violation-title">ì‹¤ì‹œê°„ ìœ„ë°˜ ë‚´ì—­</div>
            <div class="violation-list" id="violationList">
              <div class="violation-item text-muted">ì—°ê²° ì¤‘...</div>
            </div>
          </div>
        </section>
      </aside>

      <section class="content" id="content">
        <div class="page" id="live">
          <h2>ğŸ“º ì‹¤ì‹œê°„ í™”ë©´</h2>
          <div class="video-card">
            <div class="video-frame" id="videoFrame">
              <img id="video-feed" src="{{ url_for('video_feed') }}" alt="video feed" />
              <button id="uploadTrigger" class="upload-trigger" title="ì˜ìƒ/ì¹´ë©”ë¼ ì—…ë¡œë“œ">ğŸ¥</button>
            </div>
            <div class="roi-info" id="roiInfo">
              <div>ì„¤ì •ëœ ì¢Œí‘œ ë¡œê·¸</div>
              <div id="roiLog" class="roi-log">(ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ROIë¥¼ ì„¤ì •í•˜ì„¸ìš”)</div>
            </div>
            <div id="roiControls" class="roi-controls hidden">
              <button id="roiStart" class="btn primary">ROI ì„¤ì • ì‹œì‘</button>
              <button id="roiReset" class="btn">ì´ˆê¸°í™”</button>
              <button id="roiDone" class="btn">ì„¤ì • ì™„ë£Œ</button>
            </div>
          </div>
        </div>

        <div class="page hidden" id="playback">
          <h2>ğŸ“‚ ìœ„ë°˜ ì¦ê±° ê¸°ë¡ (Playback)</h2>
          <div id="playbackList" class="playback-grid">
            </div>
        </div>
      </section>
    </main>

    <script src="{{ url_for('static', filename='script.js') }}"></script>

    <script>
        // ì „ì—­ ë³€ìˆ˜ë¡œ ìµœì‹  ë¡œê·¸ ë³´ê´€
        let latestLogs = [];

        // 1. ì‹¤ì‹œê°„ ìƒíƒœ ë° ë¡œê·¸ ì—…ë°ì´íŠ¸ (1ì´ˆë§ˆë‹¤)
        setInterval(() => {
            fetch('/get_status')
                .then(res => res.json())
                .then(data => {
                    latestLogs = data.logs; // Playback ê°±ì‹ ì„ ìœ„í•´ ì €ì¥
                    
                    const sigBoard = document.getElementById('signalBoard');
                    if(sigBoard) {
                        sigBoard.innerText = data.signal;
                        sigBoard.setAttribute('data-state', data.signal);
                    }

                    const logDiv = document.getElementById('violationList');
                    if(logDiv && data.logs) {
                        logDiv.innerHTML = data.logs.slice().reverse().map(l => 
                            `<div class="violation-item">${l}</div>`
                        ).join('');
                    }
                })
                .catch(err => console.error("ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:", err));
        }, 1000);

        // 2. ë©”ë‰´ íƒ­ ì „í™˜ ë° Playback ë Œë”ë§ ë¡œì§
        document.querySelectorAll('.sidebar nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetPage = e.target.getAttribute('data-page');
                
                // ëª¨ë“  í˜ì´ì§€ ìˆ¨ê¸°ê³  ì„ íƒëœ í˜ì´ì§€ë§Œ í‘œì‹œ
                document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
                const activePage = document.getElementById(targetPage);
                if(activePage) activePage.classList.remove('hidden');

                // ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™” í‘œì‹œ
                document.querySelectorAll('.sidebar nav a').forEach(a => a.classList.remove('active'));
                e.target.classList.add('active');

                // Playback í˜ì´ì§€ í´ë¦­ ì‹œ 2ì—´ ê·¸ë¦¬ë“œ ìƒì„±
                if(targetPage === 'playback') {
                    renderPlayback();
                }
            });
        });

        function renderPlayback() {
            const container = document.getElementById('playbackList');
            if(!container) return;

            if(latestLogs.length === 0) {
                container.innerHTML = "<p>ê¸°ë¡ëœ ìœ„ë°˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                return;
            }

            container.innerHTML = latestLogs.slice().reverse().map(logHtml => {
                // ë¡œê·¸ HTML ë¬¸ìì—´ì—ì„œ ë°ì´í„° ì¶”ì¶œ
                // ì˜ˆ: [12:00:00] ID 5 ìœ„ë°˜ <a href='/violation/file.jpg' ...>
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = logHtml;
                const link = tempDiv.querySelector('a');
                const imgUrl = link ? link.getAttribute('href').replace('/violation/', '/static/violations/') : '';
                const detailUrl = link ? link.getAttribute('href') : '#';
                const text = tempDiv.innerText.replace('[ë³´ê¸°]', '').trim();

                return `
                    <div class="evidence-card">
                        <img src="${imgUrl}" alt="ìœ„ë°˜ ì¦ê±°" onerror="this.src='https://via.placeholder.com/300?text=No+Image'">
                        <div class="evidence-info">
                            <b>ğŸš¨ ìœ„ë°˜ íƒì§€</b><br>
                            ${text}<br>
                            <a href="${detailUrl}" target="_blank" style="color:blue; text-decoration:underline;">ìƒì„¸ ë³´ê¸° (Full Resolution)</a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 3. ROI ì„¤ì • ì™„ë£Œ ì‹œ ì„œë²„ë¡œ ì¢Œí‘œ ì „ì†¡
        document.getElementById('roiDone').addEventListener('click', () => {
            if (typeof roiPoints !== 'undefined' && roiPoints.length >= 3) {
                fetch('/set_roi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ points: roiPoints })
                })
                .then(res => res.json())
                .then(result => {
                    if(result.status === "success") {
                        alert("ROI ì„¤ì •ì´ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                });
            } else {
                alert("ìµœì†Œ 3ê°œ ì´ìƒì˜ ì¢Œí‘œë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
            }
        });
    </script>
  </body>
</html>