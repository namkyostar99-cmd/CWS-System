<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CCTV ê´€ì œì‹¤</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <header class="topbar">
      <div class="left">
        <img id="logo" src="{{ url_for('static', filename='ê·¸ë¦¼1.png') }}" alt="logo" />
        <div class="brand">
          <h1>Yellow YOLO</h1>
          <div class="subtitle">CCTV ê´€ì œ ëŒ€ì‹œë³´ë“œ</div>
        </div>
      </div>
      <div class="right">
        <div id="userArea">
          <button id="loginBtn" class="btn">ë¡œê·¸ì¸</button>
        </div>
      </div>
    </header>

    <main class="container">
      <aside class="sidebar">
        <nav>
          <ul>
            <li><a href="#" data-page="overview">Overview</a></li>
            <li><a href="#" data-page="live" class="active">Live Feeds</a></li>
            <li><a href="#" data-page="playback">Playback</a></li>
            <li><a href="#" data-page="settings">Settings</a></li>
          </ul>
        </nav>
        <section class="status">
          <h4>âœ’ï¸ ìƒíƒœ ë° ê¸°ë¡</h4>
          <div class="status-subtitle">ì‹ í˜¸ë“± ì „ê´‘íŒ</div>
          <div class="signal-board" id="signalBoard" data-state="RED">RED</div>
          <div class="violation-wrap">
            <div class="violation-title">ì‹¤ì‹œê°„ ìœ„ë°˜ ë‚´ì—­</div>
            <div class="violation-list" id="violationList">
              <div class="violation-item text-muted">ì—°ê²° ì¤‘...</div>
            </div>
          </div>
        </section>
      </aside>

      <section class="content" id="content">
        <div class="page" id="live">
          <h2>ğŸ“º ì‹¤ì‹œê°„ í™”ë©´</h2>
          <div class="video-card">
            <div class="video-frame" id="videoFrame">
              <img id="video-feed" src="{{ url_for('video_feed') }}" alt="video feed" />
              <button id="uploadTrigger" class="upload-trigger" title="ì˜ìƒ/ì¹´ë©”ë¼ ì—…ë¡œë“œ">ğŸ¥</button>
            </div>
            <div class="roi-info" id="roiInfo">
              <div>ì„¤ì •ëœ ì¢Œí‘œ ë¡œê·¸</div>
              <div id="roiLog" class="roi-log">(ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ROIë¥¼ ì„¤ì •í•˜ì„¸ìš”)</div>
            </div>
            <div id="roiControls" class="roi-controls hidden">
              <button id="roiStart" class="btn primary">ROI ì„¤ì • ì‹œì‘</button>
              <button id="roiReset" class="btn">ì´ˆê¸°í™”</button>
              <button id="roiDone" class="btn">ì„¤ì • ì™„ë£Œ</button>
            </div>
          </div>
        </div>

        </section>
    </main>

    <script src="{{ url_for('static', filename='script.js') }}"></script>

    <script>
        // 1. ì‹¤ì‹œê°„ ìƒíƒœ ë° ë¡œê·¸ ì—…ë°ì´íŠ¸ (1ì´ˆë§ˆë‹¤)
        setInterval(() => {
            fetch('/get_status')
                .then(res => res.json())
                .then(data => {
                    // ì‹ í˜¸ë“± ìƒíƒœ ì—…ë°ì´íŠ¸
                    const sigBoard = document.getElementById('signalBoard');
                    if(sigBoard) {
                        sigBoard.innerText = data.signal;
                        sigBoard.setAttribute('data-state', data.signal);
                    }

                    // ìœ„ë°˜ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                    const logDiv = document.getElementById('violationList');
                    if(logDiv && data.logs) {
                        // `${l}` í˜•íƒœë¡œ ë°”ë¡œ ì¶œë ¥ (Pythonì—ì„œ <a>íƒœê·¸ í¬í•¨ ë¬¸ìì—´ë¡œ ë³´ëƒ„)
                        logDiv.innerHTML = data.logs.slice().reverse().map(l => 
                            `<div class="violation-item">${l}</div>`
                        ).join('');
                    }
                })
                .catch(err => console.error("ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:", err));
        }, 1000);

        // 2. ROI ì„¤ì • ì™„ë£Œ ì‹œ ì„œë²„ë¡œ ì¢Œí‘œ ì „ì†¡ (script.jsì˜ roiPoints ì‚¬ìš©)
        document.getElementById('roiDone').addEventListener('click', () => {
            // script.js ë‚´ë¶€ì— ì„ ì–¸ëœ roiPoints ë³€ìˆ˜ì— ì ‘ê·¼
            if (typeof roiPoints !== 'undefined' && roiPoints.length >= 3) {
                fetch('/set_roi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ points: roiPoints })
                })
                .then(res => res.json())
                .then(result => {
                    if(result.status === "success") {
                        alert("ROI ì„¤ì •ì´ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                });
            } else {
                alert("ìµœì†Œ 3ê°œ ì´ìƒì˜ ì¢Œí‘œë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
            }
        });
    </script>
  </body>
</html>